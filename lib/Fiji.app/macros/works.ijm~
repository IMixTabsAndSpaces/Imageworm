macro 'convert ND2 tiff' {

/*
 * - converts LIF files into TIFF. 
 * - the macro ask for an input folder that should contain 1 or more lif files. Nothing else.
 * - each series is saved as one tiff. The name of the series is appended to the file name.
 * - if the series has more the one frame, a Max Intensity projection is performed before saving
 * - the TIFFs are saved in a folder generated by the macro
 * 
 * Martin Hoehne, August 2015
 * 
 *  Update October 2015: works for Multichannel images as well
 */
input = getDirectory("input dir"); 
list = getFileList(input); 
output = getDirectory("out dir");

for (i=0; i<list.length; i++)                                                          
{
    image = list[i];
    path = input + image;
    run("Bio-Formats Macro Extensions");
    Ext.setId(path);
    Ext.getCurrentFile(file);
    Ext.getSeriesCount(seriesCount);
    run("Bio-Formats Importer", "open=&path autoscale color_mode=Default view=Hyperstack stack_order=XYCZT series_");

    t=getTitle();
    date = substring(t, 0, 10);
    sub_output = output + date;
    File.makeDirectory(sub_output);                                                 
    close();

    for (s=1; s<=seriesCount; s++)                                                  
    {
        run("Bio-Formats Importer", "open=&path autoscale color_mode=Default split_channels view=Hyperstack stack_order=XYCZT series_"+s); 
        subtitle=getTitle();
        DirPath = sub_output+subtitle;
	File.makeDirectory(DirPath);
	run("Image Sequence... ", "format=TIFF save=[sub_output+"/"+subtitle+"_Seq0000_t001_z001_c001.tif"]");
        run ("Close All");
    }
}



showMessage(" -- finished --");	
run("Close All");
setBatchMode(false);

} // macro


